# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Breadbox is a FastAPI-based persistent service for storing and retrieving datasets for the DepMap portal. It provides APIs for uploading, fetching, and managing matrix and tabular datasets with group-based access control.

## Common Commands

```bash
# Setup (first time only)
./install_prereqs.sh

# Activate poetry environment (required before running commands)
poetry shell

# Run the app (available at http://127.0.0.1:8000/docs)
./bb run

# Run with proxy (for testing behind DepMap portal)
./bb run --with_proxy

# Run tests
pytest

# Run a single test file
pytest tests/api/test_datasets.py

# Run a single test
pytest tests/api/test_datasets.py::test_function_name

# Run slow tests (skipped by default)
pytest --runslow

# Skip celery tests
pytest --skipcelery

# Database operations
./bb upgrade-db              # Apply migrations
./bb recreate-dev-db         # Reset database with sample data

# Run background worker (requires redis-server running)
./bb run_worker
./bb run_dev_worker          # Debug mode: single worker, no stdout capture

# Update breadbox-client after API changes
./bb update-client

# Interactive shell with db and settings loaded
./bb shell

# Format commits using commitizen
poetry run cz c
```

## Database Migrations

Uses SQLAlchemy + Alembic. Migration workflow:
1. Modify models in `breadbox/models/`
2. Generate migration: `alembic revision --autogenerate -m "description"`
3. Review generated file in `alembic/versions/`
4. Apply: `./bb upgrade-db`

## Architecture

### Layer Structure

- **`breadbox/api/`** - FastAPI route handlers. No direct DB calls allowed; delegates to crud layer. Parameter order: `(**request_parameters, db: SessionWithUser, user: str, settings: Settings)`

- **`breadbox/crud/`** - Data access layer. All DB operations go here. All public methods must check permissions and take a user parameter. Parameter order: `(db: SessionWithUser, user: str, settings: Settings, **other_parameters)`

- **`breadbox/service/`** - Business logic that orchestrates crud operations

- **`breadbox/schemas/`** - Pydantic models for request/response validation

- **`breadbox/models/`** - SQLAlchemy ORM models (Dataset, Group, DimensionType, DataType)

- **`breadbox/compute/`** - Celery task definitions for background processing

### Access Control

- Users without write access to a dataset's group get 403 errors
- Users who don't belong to the group get 404 errors (prevents leaking dataset existence)
- Special groups: `PUBLIC_GROUP_ID` (read for all), `TRANSIENT_GROUP_ID` (write for all)

### Key Fixtures for Tests

- `db` - SQLAlchemy session
- `client` - FastAPI TestClient
- `settings` - Test Settings instance
- `minimal_db` - Database with public/transient groups and basic dimension types
- `mock_celery` - Mocked celery for testing async tasks

## Commit Conventions

Uses commitizen with scoped commits. Format: `type(breadbox): message`

- `fix(breadbox):` - Bug fix (PATCH)
- `feat(breadbox):` - New feature (MINOR)
- `feat(breadbox)!:` or `fix(breadbox)!:` - Breaking change (MAJOR)

Other types: `build`, `chore`, `test`, `refactor`, `docs`, `perf`, `ci`

## FastAPI Optional Fields Note

FastAPI does not mark `Optional` fields as `nullable` in OpenAPI schema. For the autogenerated client to accept `None` values, fields must have `nullable=True` in the Pydantic Field definition:

```python
x: Optional[int] = Field(nullable=True)
```
