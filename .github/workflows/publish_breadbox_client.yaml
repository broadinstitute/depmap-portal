---
name: Publish breadbox client

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "The tag/branch to checkout"
        required: true
        default: "master"
jobs:
  publish-breadbox-client:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v3
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          fetch-depth: 0
      - run: |
          git pull origin HEAD:${{ inputs.tag }}
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          # See instructions here: https://github.com/google-github-actions/auth?tab=readme-ov-file#service-account-key-json
          credentials_json: ${{ secrets.DEPMAP_ARTIFACTS_SVC_ACCT }}
      - name: Install and configure Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true
      - name: Set up cache
        uses: actions/cache@v2
        id: cached-poetry-dependencies
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ steps.full-python-version.outputs.version }}-${{ hashFiles('**/poetry.lock') }}
      - name: Generate breadbox client
        uses: ./.github/actions/generate-breadbox-client # defined as a re-usable action
        # the above does a checkout which deletes the credential file, so we need to execute authenticate to google cloud after it
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          # See instructions here: https://github.com/google-github-actions/auth?tab=readme-ov-file#service-account-key-json
          credentials_json: ${{ secrets.DEPMAP_ARTIFACTS_SVC_ACCT }}
      - name: Set up for publishing breadbox client
        working-directory: ./breadbox-client
        run: |
          poetry self add keyrings.google-artifactregistry-auth
          poetry config repositories.public-python https://us-central1-python.pkg.dev/cds-artifacts/public-python/
      - name: Publish new breadbox client version to Artifact Registry
        working-directory: ./breadbox-client
        run: poetry publish --build --repository public-python
