---
name: Build breadbox client

on:
  push:
    paths:
      - "breadbox/**"
      - "breadbox-client/**"
      - ".github/workflows/build_breadbox_client.yaml"

# v1
#permissions:
#  contents: write

env:
  DOCKER_REPO: us.gcr.io/broad-achilles/depmap-breadbox
  DOCKER_TAG: ga2-build-${{ github.run_number }}

jobs:
  build-breadbox-client:
    runs-on: ubuntu-latest
    steps:
      - name: "Check out"
        uses: actions/checkout@v3
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          fetch-depth: 0

      - name: Prepare breadbox client
        uses: ./.github/actions/prepare-breadbox-client # checks out and generates breadbox client code

      - name: "Install breadbox and dependencies"
        working-directory: ./breadbox
        run: "poetry install"

      - name: "Install breadbox_client and dependencies"
        working-directory: ./breadbox-client
        run: "poetry install"

      - name: getting env 1 path
        working-directory: ./breadbox-client
        run: "poetry run which python"

      - name: getting env 1 path
        working-directory: ./breadbox-client
        run: "poetry show"

      - name: getting env 2 path
        working-directory: ./breadbox
        run: "poetry run bash -c 'cd ../breadbox && poetry run which python'"

      - name: getting env 2 path
        working-directory: ./breadbox
        run: "poetry run bash -c 'cd ../breadbox && poetry run printenv'"

      - name: getting env 2 path
        working-directory: ./breadbox
        run: "poetry run bash -c 'cd ../breadbox && poetry show'"

      - name: Running pyright
        working-directory: ./breadbox-client
        run: "poetry run pyright breadbox_facade"

      - name: Running pytest
        working-directory: ./breadbox-client
        run: "poetry run pytest"
